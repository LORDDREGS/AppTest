<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управление подразделениями</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }
        .action-buttons {
            margin-top: 20px;
        }
        .edit-input {
            width: 100%;
        }
    </style>
</head>
<body>
    <h1>Управление подразделениями</h1>
    <div>
        <h2>Форма подразделения</h2>
        <input type="hidden" id="departmentId" />
        <p>
            Название:<br />
            <input id="departmentName" />
        </p>
        <p>
            Краткое название:<br />
            <input id="departmentShortName" />
        </p>
        <p>
            Завод:<br />
            <select id="departmentPlant">
                <option value="">Выберите завод</option>
                <!-- Динамически заполняется через JavaScript -->
            </select>
        </p>
        <p>
            Аудитор:<br />
            <input id="departmentIsAuditor" type="checkbox" />
        </p>
        <p>
            <button id="saveBtn">Сохранить</button>
            <button id="resetBtn">Сбросить</button>
        </p>
    </div>
    <div class="action-buttons">
        <button onclick="resetForm()">Добавить новое подразделение</button>
        <a href="index.html" target="_blank">Назад к управлению пользователями</a>
    </div>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Название</th>
                <th>Краткое название</th>
                <th>Завод</th>
                <th>Аудитор</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody id="departmentList"></tbody>
    </table>

    <script>
        const departmentList = document.getElementById('departmentList');
        const departmentPlantSelect = document.getElementById('departmentPlant');
        const baseUrl = '/api/departments'; // Базовый URL для всех подразделений
        const plantUrl = '/api/plants'; // Базовый URL для всех заводов
        let plants = [];

        // Получение всех заводов для заполнения выпадающего списка и последующего использования
        async function getPlants() {
            try {
                const response = await fetch(plantUrl);
                if (!response.ok) throw new Error('Не удалось получить заводы');
                plants = await response.json();
                departmentPlantSelect.innerHTML = '<option value="">Выберите завод</option>' +
                    plants.map(plant => `<option value="${plant.id}">${plant.name}</option>`).join('');
            } catch (error) {
                console.error('Ошибка при загрузке заводов:', error);
            }
        }

        // Получение всех подразделений
        async function getDepartments() {
            try {
                const response = await fetch(baseUrl);
                if (!response.ok) throw new Error('Не удалось получить подразделения');
                const departments = await response.json();
                departmentList.innerHTML = departments.map(department => createDepartmentRow(department)).join('');
            } catch (error) {
                console.error('Ошибка при загрузке подразделений:', error);
            }
        }

        // Получение одного подразделения по ID
        async function getDepartment(id) {
            try {
                const response = await fetch(`${baseUrl}/${id}`);
                if (!response.ok) throw new Error('Не удалось получить подразделение');
                const department = await response.json();
                document.getElementById("departmentId").value = department.id;
                document.getElementById("departmentName").value = department.name || '';
                document.getElementById("departmentShortName").value = department.shortName || '';
                departmentPlantSelect.value = department.plant || ''; // Устанавливаем выбранное значение завода
                document.getElementById("departmentIsAuditor").checked = department.isAuditor || false;
            } catch (error) {
                console.error('Ошибка при получении подразделения:', error);
            }
        }

        // Добавление нового подразделения
        async function createDepartment(department) {
            try {
                const response = await fetch(baseUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(department)
                });
                if (!response.ok) throw new Error('Не удалось создать подразделение');
                const newDepartment = await response.json();
                departmentList.insertAdjacentHTML('afterbegin', createDepartmentRow(newDepartment));
            } catch (error) {
                console.error('Ошибка при создании подразделения:', error);
            }
        }

        // Изменение подразделения
        async function editDepartment(department) {
            try {
                if (!department.id) {
                    console.error('Ошибка: ID подразделения не указан для обновления');
                    return; // Прекращаем выполнение, если ID не задан
                }

                const response = await fetch(`${baseUrl}/${department.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(department)
                });
                if (!response.ok) throw new Error('Не удалось обновить подразделение');
                const updatedDepartment = await response.json();
                const rowElement = document.querySelector(`tr[data-id='${department.id}']`);
                if (rowElement) rowElement.outerHTML = createDepartmentRow(updatedDepartment);
            } catch (error) {
                console.error('Ошибка при обновлении подразделения:', error);
            }
        }

        // Удаление подразделения
        async function deleteDepartment(rowElement) {
            const departmentId = rowElement.dataset.id;
            if (!departmentId) {
                console.error('Ошибка: ID подразделения не указан или недопустим');
                return; // Прекращаем выполнение, если ID не задан
            }

            try {
                const response = await fetch(`${baseUrl}/${departmentId}`, {
                    method: 'DELETE'
                });
                if (!response.ok) throw new Error('Не удалось удалить подразделение');
                rowElement.remove();
            } catch (error) {
                console.error('Ошибка при удалении подразделения:', error);
            }
        }

        function resetForm() {
            document.getElementById("departmentId").value = '';
            document.getElementById("departmentName").value = '';
            document.getElementById("departmentShortName").value = '';
            departmentPlantSelect.value = ''; // Сброс выбора завода
            document.getElementById("departmentIsAuditor").checked = false; // Сброс флага "Аудитор"
        }

        // Создание строки подразделения для таблицы
        function createDepartmentRow(department) {
            const plantName = plants.find(plant => plant.id === department.plant)?.name || 'Не указан';
            return `
                <tr data-id="${department.id}">
                    <td>${department.id}</td>
                    <td>${department.name}</td>
                    <td>${department.shortName || ''}</td>
                    <td>${plantName}</td>
                    <td>${department.isAuditor ? 'Да' : 'Нет'}</td>
                    <td>
                        <button onclick="getDepartment('${department.id}')">Редактировать</button>
                        <button onclick="deleteDepartment(this.parentElement.parentElement)">Удалить</button>
                    </td>
                </tr>`;
        }

        // Обработка нажатия кнопки "Сохранить"
        document.getElementById('saveBtn').addEventListener('click', async () => {
            const department = {
                id: document.getElementById("departmentId").value,
                name: document.getElementById("departmentName").value,
                shortName: document.getElementById("departmentShortName").value,
                plant: departmentPlantSelect.value,
                isAuditor: document.getElementById("departmentIsAuditor").checked
            };

            if (department.id) {
                await editDepartment(department);
            } else {
                await createDepartment(department);
            }

            resetForm();
        });

        // Обработка нажатия кнопки "Сбросить"
        document.getElementById('resetBtn').addEventListener('click', resetForm);

        // Инициализация данных
        document.addEventListener('DOMContentLoaded', () => {
            getPlants();
            getDepartments();
        });
    </script>
</body>